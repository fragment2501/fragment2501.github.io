---
title: Windows 2008R2 (IIS 7.5) ASP.NET 4.0 Configuration For Impersonation
date: '2011-01-03T09:20:00.000-08:00'
tags:
- ".NET"
- Windows 2008R2
modified_time: '2011-01-03T09:20:06.120-08:00'
blogger_id: tag:blogger.com,1999:blog-19111454.post-5560610996011671350
blogger_orig_url: http://www.bryansgeekspeak.com/2011/01/windows-2008r2-iis-75-aspnet-40.html
---

Admittedly I am still learning a lot about .NET - and recently I was stumped on how to configure an IIS website properly to allow ASP.NET code to impersonate the user hitting the website.  Impersonation doesnt seem to be a very common thing to do - often we hard code account credentials to access things like database repositories - but this case, I was using a workflow product called K2 which allows you to use their C# API to access their workflow engine so that the user hitting your application can access and manipulate their tasks on the K2 workflow server.  To allow my web application to allow you to manipulate workflow tasks on that remote K2 server, I need impersonation.  <br /><br />In my first attempt at building a custom web form for workflow tasks I used the default settings in IIS 7.5 for a new website.  In my web application, my C# calls to connect to the workflow server threw errors saying the IIS application pool account did not have rights to access the task I was trying to run.  That makes sense, I needed to use the logged in user account rather than the application pool.  It took a bit of guess-n-test, but I found a configuration that allows this kind of impersonation to happen - and thankfully in this case kerberos is not required (single hop impersonation works with NTLM).<br /><br />The tricky part was enabling support for the .NET 4.0 framework on Windows Server 2008R2 - I still cant believe microsoft disables their latest and greatest ASP.NET version on a windows 2008 product -.-  Anyway, here's what I did:<br /><br /><ol><li>Install server Features required for IIS integrated authentication and impersonation. From the Server Manager tool, confirm the following:</li><ol><li>Confirm  the "Web Server (IIS)" Role is installed.</li><li>Confirm the "Windows Authentication" feature is installed, along with any other features required for your web application (ASP.NET, ISAPI Extension/Filters, etc).</li></ol><li>Enable .NET 4.0 framework (this took me forever to figure out!)</li><ol><li>Launch the "Internet Information Services (IIS) Manager" tool.</li><li>Click on the root IIS server in the "Connections" pane, then open the "ISAPI and CGI Restrictions" tool from the Features View pane.</li><li>Set both versions of "ASP.NET v4.0.xxxxx" to "Allowed"</li></ol><li>Disable Anonymous Authentication for the site. Enable Windows authentication and Impersonation.</li><ol><li>Launch the "Internet Information Services (IIS) Manager" tool.</li><li>Click on your website in the "Connections" pane, then open the "Authentication" tool from the Features View pane.</li><li>Disable "Anonymous Authentication". Enable both "Windows Authentication" and ASP.NET Impersonation.</li><li> Click on "Windows Authentication", then click "Advanced Settings" and confirm that "Extended Protection" is turned off and that "Enable Kernel-mode authentication" is not checked.</li></ol><li>Modify the web application web.config to support impersonation. Here is an example:<br /><br /><div class="code">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;<br />&lt;configuration&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&lt;system.webServer&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;security&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;authentication&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;anonymousAuthentication enabled=&quot;false&quot; /&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;windowsAuthentication enabled=&quot;true&quot; /&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/authentication&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/security&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&lt;/system.webServer&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&lt;system.web&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;identity impersonate=&quot;true&quot; /&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&lt;/system.web&gt;<br />&lt;/configuration&gt;<br /></div></ol>