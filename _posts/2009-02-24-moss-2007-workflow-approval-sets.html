---
layout: post
title: MOSS 2007 - Workflow Approval Sets Modified By to "System Account"
date: '2009-02-24T08:47:00.000-08:00'
author: Bryan
tags:
- MOSS
- SharePoint
modified_time: '2009-03-06T08:57:25.903-08:00'
blogger_id: tag:blogger.com,1999:blog-19111454.post-8516340009626507051
blogger_orig_url: http://www.bryansgeekspeak.com/2009/02/moss-2007-workflow-approval-sets.html
---

<div class="sidenote">NOTE that a better/working event handler Visual Studio 2008 project is provided in <a href="http://bryansgeekspeak.blogspot.com/2009/03/moss-2007-show-sharepoint-version_06.html">Part2</a>.  Download that project, build it, then use the Feature.xml, Elements.xml and UpdateColumns.dll from that project.  Use the instructions shown here to perform the install on your SharePoint server.</div><br /><br />I've been looking for a solution to this issue for a few days now.  The basic problem is that when you use an Approval workflow (even a "No code" workflow) in MOSS 2007, as items are approved, the "Modified By" value of the item is set to "System Account" due to the way the Window Workflow service works.  People who are using MOSS 2007 to track who last changed what then run into the issue of not being able to easily see who last touched the item as it goes through the approval process.<br /><br />A good example of the problem is when you are trying use the Content Query Web Part to return a list of all items modified in the past two weeks.  The report is fairly easy to configure, but when displaying the Modified By field again only shows "System Account" if the item is being processes by an approval workflow.  So far, I havent found any columns that show what I would call the "Editor" without displaying the "System Account" during an approval.<br /><br />Once I gave up on trying to find an existing column that would work, I started looking into custom code options.  I found this blog article with more details about the actual problem and a possible work around using an event handler:<br /><br /><a href="http://blogs.msdn.com/sowmyancs/archive/2008/06/21/how-to-show-task-creator-modifier-name-instead-of-system-account-in-the-task-library.aspx">How to show task creator's &amp; modifier's name instead of "System Account" in the Task Library</a><br /><br />The idea here is to use a custom event handler on the Workflow Task List to capture the ItemAdded and ItemUpdated events on a task.  We then try and override the Modified By column with the value of the user name of the person performing the action at the end of the event.<br /><br />Unfortunately, the instructions are not very detailed.  It took me about a day to figure out how to create and install a custom event handler using a feature.  And testing changes to the handler can be even more tricky...sometimes you need to reset IIS to see your changes, so dont forget to do that when you install new event handler assemblies (I always do an iis reset when I uninstall a feature now, so that if I need to re-install it I know it wont be "cached" by iis).<br /><br />Even after getting the event handler to execute, I still had no success with changing the Modified By to be the actual user account of the Editor, and I'm not sure exactly why it does not work.  I'm going to spend another day or two testing this out to see if I missed something, and I'll be posting a complete example of how to install an event handler that overrides multiple item level events.<br /><br><br /><hr style="width: 50%"><br /><br />Here is my attempt at implementing the Event Handler described in the link above.  The code compiles and seems to fire off, but it does not override the System Account as the Modified By as I would expect it to.  I can, however, change the methods to ItemAdding and ItemUpdating and abort with error messages, that does seem to work.  So I think I'm on the right track here, but perhaps these properties arent actually doing what I expect them to...<br /><br /><span style="font-weight:bold;">Feature.xml</span><br />The feature ID must be a unique GUID, be sure to <a href="http://createguid.com/">generate a new GUID</a> one before you deploy the feature.<br /><br /><div class="code"><br /><font color="#0000ff">&lt;?</font><font color="#2e8b57"><b>xml</b></font><font color="#2e8b57"><b>&nbsp;</b></font><font color="#2e8b57"><b>version</b></font>=<font color="#ff00ff">"1.0"</font><font color="#2e8b57"><b>&nbsp;</b></font><font color="#2e8b57"><b>encoding</b></font>=<font color="#ff00ff">"utf-8"</font><font color="#0000ff">?&gt;</font><br /><font color="#008080">&lt;</font><font color="#008080">Feature</font><font color="#008080">&nbsp;</font><font color="#2e8b57"><b>Id</b></font>=<font color="#ff00ff">"A3A53813-E68A-4EF8-9C4A-FB0A839A088A"</font><font color="#008080">&nbsp;</font><br /><font color="#008080">&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#2e8b57"><b>Title</b></font>=<font color="#ff00ff">"UpdateColumns"</font><br /><font color="#008080">&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#2e8b57"><b>Description</b></font>=<font color="#ff00ff">"An event handler that catches ItemAdded and ItemUpdated events, then replaces the Modified By to match that of the editor to bypass the System User issue."</font><br /><font color="#008080">&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#2e8b57"><b>Scope</b></font>=<font color="#ff00ff">"Web"</font><br /><font color="#008080">&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="#2e8b57"><b>xmlns</b></font>=<font color="#ff00ff">"<a href="http://schemas.microsoft.com/sharepoint/">http://schemas.microsoft.com/sharepoint/</a>"</font><font color="#008080">&gt;</font><br />&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">&lt;</font><font color="#008080">ElementManifests</font><font color="#008080">&gt;</font><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">&lt;</font><font color="#008080">ElementManifest</font><font color="#008080">&nbsp;</font><font color="#2e8b57"><b>Location</b></font>=<font color="#ff00ff">"Elements.xml"</font><font color="#008080">/&gt;</font><br />&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">&lt;/ElementManifests&gt;</font><br /><font color="#008080">&lt;/Feature&gt;</font><br /><br /></div><br /><br /><span style="font-weight:bold;">Elements.xml</span><br />In order to allow your assembly to act on several types of events (in this case, the ItemAdded and ItemUpdated events), you'll need to add a new Receiver for each event you intend to capture in the Elements.xml file. you'll note that the "ListTemplateID" is set to 107, which is the internal ID for the sharepoint task list.  Also, the PublicKeyToken must match that of your assembly. When you install the assembly to the server GAC, you can view the properties of the assembly there to find the PublicKeyToken.<br /><br /><div class="code"><br /><font color="#0000ff">&lt;?</font><font color="#2e8b57"><b>xml</b></font><font color="#2e8b57"><b>&nbsp;</b></font><font color="#2e8b57"><b>version</b></font>=<font color="#ff00ff">"1.0"</font><font color="#2e8b57"><b>&nbsp;</b></font><font color="#2e8b57"><b>encoding</b></font>=<font color="#ff00ff">"utf-8"</font><font color="#0000ff">?&gt;</font><br /><font color="#008080">&lt;</font><font color="#008080">Elements</font><font color="#008080">&nbsp;</font><font color="#2e8b57"><b>xmlns</b></font>=<font color="#ff00ff">"<a href="http://schemas.microsoft.com/sharepoint/">http://schemas.microsoft.com/sharepoint/</a>"</font><font color="#008080">&gt;</font><br />&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">&lt;</font><font color="#008080">Receivers</font><font color="#008080">&nbsp;</font><font color="#2e8b57"><b>ListTemplateId</b></font>=<font color="#ff00ff">"107"</font><font color="#008080">&gt;</font><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">&lt;</font><font color="#008080">Receiver</font><font color="#008080">&gt;</font><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">&lt;</font><font color="#008080">Name</font><font color="#008080">&gt;</font>UpdateColumns<font color="#008080">&lt;/Name&gt;</font><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">&lt;</font><font color="#008080">Type</font><font color="#008080">&gt;</font>ItemAdded<font color="#008080">&lt;/Type&gt;</font><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">&lt;</font><font color="#008080">SequenceNumber</font><font color="#008080">&gt;</font>20010<font color="#008080">&lt;/SequenceNumber&gt;</font><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">&lt;</font><font color="#008080">Assembly</font><font color="#008080">&gt;</font><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UpdateTaskColumns, Version=1.0.0.0, culture=neutral, PublicKeyToken=9c85e3ff7e12eba3<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">&lt;/Assembly&gt;</font><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">&lt;</font><font color="#008080">Class</font><font color="#008080">&gt;</font>UpdateTaskColumns.UpdateColumns<font color="#008080">&lt;/Class&gt;</font><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">&lt;/Receiver&gt;</font><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">&lt;</font><font color="#008080">Receiver</font><font color="#008080">&gt;</font><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">&lt;</font><font color="#008080">Name</font><font color="#008080">&gt;</font>UpdateColumns<font color="#008080">&lt;/Name&gt;</font><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">&lt;</font><font color="#008080">Type</font><font color="#008080">&gt;</font>ItemUpdated<font color="#008080">&lt;/Type&gt;</font><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">&lt;</font><font color="#008080">SequenceNumber</font><font color="#008080">&gt;</font>20011<font color="#008080">&lt;/SequenceNumber&gt;</font><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">&lt;</font><font color="#008080">Assembly</font><font color="#008080">&gt;</font><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UpdateTaskColumns, Version=1.0.0.0, culture=neutral, PublicKeyToken=9c85e3ff7e12eba3<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">&lt;/Assembly&gt;</font><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">&lt;</font><font color="#008080">Class</font><font color="#008080">&gt;</font>UpdateTaskColumns.UpdateColumns<font color="#008080">&lt;/Class&gt;</font><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">&lt;/Receiver&gt;</font><br />&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008080">&lt;/Receivers&gt;</font><br /><font color="#008080">&lt;/Elements&gt;</font><br /></div><br /><br /><span style="font-weight:bold;">UpdateColumns.cs</span><br />Use the "Class Library" project type in VS so that you can compile the code down to a .dll file.  A reference to the Microsoft.SharePoint assembly is required to compile.  If you dont have SharePoint installed on your local development machine, you can simply copy the Microsoft.SharePoint.dll file from your sharepoint server to your local project directory and add a reference to it from there.  You'll also need to sign the assembly before you deploy it to the GAC.<br /><br /><div class="code"><br /><font color="#804040"><b>using</b></font>&nbsp;System;<br /><font color="#804040"><b>using</b></font>&nbsp;System.Collections.Generic;<br /><font color="#804040"><b>using</b></font>&nbsp;System.Text;<br /><font color="#804040"><b>using</b></font>&nbsp;Microsoft.SharePoint;<br /><br /><font color="#2e8b57"><b>namespace</b></font>&nbsp;UpdateTaskColumns<br />{ <br />&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>public</b></font>&nbsp;<font color="#2e8b57"><b>class</b></font>&nbsp;UpdateColumns : SPItemEventReceiver<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>public</b></font>&nbsp;<font color="#2e8b57"><b>override</b></font>&nbsp;<font color="#2e8b57"><b>void</b></font>&nbsp;ItemAdded(SPItemEventProperties properties)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UpdateUserColumns(properties, <font color="#ff00ff">false</font>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>public</b></font>&nbsp;<font color="#2e8b57"><b>override</b></font>&nbsp;<font color="#2e8b57"><b>void</b></font>&nbsp;ItemUpdated(SPItemEventProperties properties)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UpdateUserColumns(properties, <font color="#ff00ff">true</font>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>private</b></font>&nbsp;<font color="#2e8b57"><b>void</b></font>&nbsp;UpdateUserColumns(SPItemEventProperties properties, <font color="#2e8b57"><b>bool</b></font>&nbsp;IsUpdate)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SPWeb oWeb = properties.OpenWeb();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Guid oSourceListID = <font color="#804040"><b>new</b></font>&nbsp;Guid(properties.ListItem[<font color="#ff00ff">"Workflow List ID"</font>].ToString());<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SPList oSourceList = oWeb.Lists.GetList(oSourceListID, <font color="#ff00ff">true</font>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SPListItem oSourceListItem = oSourceList.GetItemById(Convert.ToInt32(properties.ListItem[<font color="#ff00ff">"Workflow Item ID"</font>]));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#804040"><b>if</b></font>&nbsp;(IsUpdate)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;properties.ListItem[<font color="#ff00ff">"Editor"</font>] = oSourceListItem[<font color="#ff00ff">"Editor"</font>];<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#804040"><b>else</b></font><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;properties.ListItem[<font color="#ff00ff">"Author"</font>] = oSourceListItem[<font color="#ff00ff">"Editor"</font>];<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;properties.ListItem[<font color="#ff00ff">"Editor"</font>] = oSourceListItem[<font color="#ff00ff">"Editor"</font>];<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;properties.ListItem.Update();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br /></div><br /><br /><span style="font-weight:bold;">Deploy Files</span><br /><ol><br /><li>Compile and copy the assembly to the server GAC</li><br /><li>Deploy Feature.xml and Elements.xml to the server's 12 hive features directory, under a new feature directory name.  For example: "<12hive>\TEMPLATE\FEATURES\UpdateColumns\"</li><br /><li>Install the feature to the farm using the STSADM command: "stsadm.exe -o installfeature -filename UpdateColumns\Feature.xml"</li><br /><li>With the feature installed at the "Web" level, you can activate the feature on individual subsites in your web application.  Browse to the site settings for the site you want to test this feature on, click "Site Features" and then click the "Activate" button for "UpdateColumns"</li><br /></ol><br /><br /><span style="font-weight:bold;">References</span><br /><ul><br /><li><a href="http://msdn.microsoft.com/en-us/library/ms453149.aspx">How to: Create an Event Handler Feature</a></li><br /><li><a href="http://bryansgeekspeak.blogspot.com/2009/03/moss-2007-show-sharepoint-version_06.html">MOSS 2007 - Workflow Approval Sets Modified By to "System Account" Part 2</a></li><br /></ul>