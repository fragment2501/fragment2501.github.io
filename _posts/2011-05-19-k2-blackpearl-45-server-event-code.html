---
title: K2 BlackPearl 4.5 Server Event Code Snips
date: '2011-05-19T12:45:00.000-07:00'
tags:
- K2
modified_time: '2011-05-19T12:53:08.822-07:00'
blogger_id: tag:blogger.com,1999:blog-19111454.post-4085575552031582180
blogger_orig_url: http://www.bryansgeekspeak.com/2011/05/k2-blackpearl-45-server-event-code.html
---

OK - I'm still new to K2, and slowly figuring out how to work with K2 in C#.  This post will be my little scrapbook of helpful code chunks for later use.<br /><br /><hr style="width:50%" /><br /><b>Get count of a specific user's worklist items for a given process - within a K2 Server Code event.</b><br />Use a new workflow client connection to the server to do all the work.<br /><br /><div class="code">// create a new workflow client connection<br />using (Connection c = new Connection())<br />{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;// Using ConnectionSetup as connection string<br />&nbsp;&nbsp;&nbsp;&nbsp;ConnectionSetup cs = new ConnectionSetup();<br />&nbsp;&nbsp;&nbsp;&nbsp;// From a server code event in a K2 process we can use K2 environment variables for connection strings<br />&nbsp;&nbsp;&nbsp;&nbsp;cs.ConnectionString = K2.StringTable[&quot;Workflow Server&quot;].ToString();<br />&nbsp;&nbsp;&nbsp;&nbsp;// Open server connection using ConnectionSetup<br />&nbsp;&nbsp;&nbsp;&nbsp;c.Open(cs);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;// Impersonate Bryan so we can get at his worklist &gt;_&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;c.ImpersonateUser(@&quot;BryansDomain\Bryan&quot;);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;// Build worklist filter criteria<br />&nbsp;&nbsp;&nbsp;&nbsp;// We only want to return work items that match a given process<br />&nbsp;&nbsp;&nbsp;&nbsp;WorklistCriteria wc = new WorklistCriteria();<br />&nbsp;&nbsp;&nbsp;&nbsp;wc.Platform = &quot;ASP&quot;;<br />&nbsp;&nbsp;&nbsp;&nbsp;wc.AddFilterField(SourceCode.Workflow.Client.WCField.ProcessName, WCCompare.Equal, &quot;BryansTestProcess&quot;);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;// dump resulting count of Bryans worklist items for the BryanTestProcess to a K2 Data Field<br />&nbsp;&nbsp;&nbsp;&nbsp;int itemCount = c.OpenWorklist(wc).TotalCount;<br />&nbsp;&nbsp;&nbsp;&nbsp;K2.ProcessInstance.DataFields[&quot;BryansWorklistCount&quot;].Value = itemCount;<br />}<br /></div><br /><br /><b>Get distinct count of process instances for a given process pending a specific activity - within a K2 Server Code event.</b><br />Use a K2 SmartObject to do all the work.<br /><br /><div class="code"><br />// Use SmartObjectClientServer for accessing SmartObjects<br />SmartObjectClientServer sos = new SmartObjectClientServer();<br /><br />// Prep the connection<br />sos.CreateConnection();<br /><br />// From within a K2 process Server Code event, use K2 environment variables for connection strings<br />sos.Connection.Open(K2.StringTable[&quot;SmartObject Server&quot;]);<br /><br />// Get an &quot;Activity Instance Destination&quot; SmartObject (an OotB K2 SmartObject)<br />SmartObject so = sos.GetSmartObject(&quot;Activity_Instance_Destination&quot;);<br /><br />// Tell the SmartObject to return a list of results<br />so.MethodToExecute = &quot;List&quot;;<br /><br />// Set filter for results - return active items pending &quot;Bryans First Activity&quot; for &quot;BryansTestProcess&quot;<br />so.Properties[&quot;ActivityName&quot;].Value = &quot;Bryans First Activity&quot;;<br />so.Properties[&quot;ProcessName&quot;].Value = &quot;BryansTestProcess&quot;;<br />so.Properties[&quot;Status&quot;].Value = &quot;Active&quot;;<br /><br />// Execute - return the results as a DataTable<br />DataTable dt = sos.ExecuteListDataTable(so);<br /><br />// If you use groups for destinations by using advanced mode to split groups to users...<br />// you can get duplicate Process Instance IDs - one for every user in the group<br />// to get a distinct list of process instances, use a datatable view to return distinct results<br />DataTable DistinctDT = dt.DefaultView.ToTable(true, &quot;Process Instance ID&quot;);<br /><br />// copy the resulting count to a K2 process data field<br />K2.ProcessInstance.DataFields[&quot;WorklistCount&quot;].Value = DistinctDT.Rows.Count;<br /><br />// and do cleanup<br />sos.Connection.Close()<br /></div>